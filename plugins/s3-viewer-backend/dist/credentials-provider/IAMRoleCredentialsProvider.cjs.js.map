{"version":3,"file":"IAMRoleCredentialsProvider.cjs.js","sources":["../../src/credentials-provider/IAMRoleCredentialsProvider.ts"],"sourcesContent":["import { LoggerService } from '@backstage/backend-plugin-api';\nimport {\n  AllowedBuckets,\n  BucketCredentials,\n  S3Platform,\n} from '@spreadshirt/backstage-plugin-s3-viewer-common';\nimport { CredentialsProvider } from '@spreadshirt/backstage-plugin-s3-viewer-node';\nimport { Config } from '@backstage/config';\nimport { fetchBucketsForPlatform } from './utils';\n\n/**\n * This class uses IAM Roles (https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html). Therefore, no\n * credentials are needed to access any bucket because, depending on the assumed role, you will be assigned\n * with temporary security credentials for your role session.\n */\nexport class IAMRoleCredentialsProvider implements CredentialsProvider {\n  constructor(\n    readonly platforms: S3Platform[],\n    readonly logger: LoggerService,\n    readonly allowedBuckets: AllowedBuckets[],\n  ) {}\n\n  static fromConfig(\n    config: Config,\n    logger: LoggerService,\n    allowedBuckets: AllowedBuckets[],\n  ): IAMRoleCredentialsProvider {\n    const platforms: S3Platform[] = config\n      .getConfigArray('platforms')\n      .map(cfg => {\n        const name = cfg.getOptionalString('name') || cfg.getString('endpoint');\n        return {\n          endpoint: cfg.getString('endpoint'),\n          endpointName: name,\n          region: cfg.getString('region'),\n        };\n      });\n\n    return new IAMRoleCredentialsProvider(platforms, logger, allowedBuckets);\n  }\n\n  async getBucketCredentials(): Promise<BucketCredentials[]> {\n    const bucketCreds: BucketCredentials[] = [];\n    await Promise.all(\n      this.platforms.map(async platform => {\n        try {\n          const buckets = await fetchBucketsForPlatform(\n            platform,\n            this.allowedBuckets,\n          );\n          const creds: BucketCredentials[] = buckets.map(b => ({\n            bucket: b,\n            endpoint: platform.endpoint,\n            endpointName: platform.endpointName,\n            region: platform.region,\n          }));\n          bucketCreds.push(...creds);\n        } catch (err) {\n          this.logger.error(\n            `Error fetching credentials for buckets in ${platform.endpoint}: ${err}`,\n          );\n        }\n      }),\n    );\n\n    return bucketCreds;\n  }\n}\n"],"names":["fetchBucketsForPlatform"],"mappings":";;;;AAeO,MAAM,0BAA0D,CAAA;AAAA,EACrE,WAAA,CACW,SACA,EAAA,MAAA,EACA,cACT,EAAA;AAHS,IAAA,IAAA,CAAA,SAAA,GAAA,SAAA;AACA,IAAA,IAAA,CAAA,MAAA,GAAA,MAAA;AACA,IAAA,IAAA,CAAA,cAAA,GAAA,cAAA;AAAA;AACR,EAEH,OAAO,UAAA,CACL,MACA,EAAA,MAAA,EACA,cAC4B,EAAA;AAC5B,IAAA,MAAM,YAA0B,MAC7B,CAAA,cAAA,CAAe,WAAW,CAAA,CAC1B,IAAI,CAAO,GAAA,KAAA;AACV,MAAA,MAAM,OAAO,GAAI,CAAA,iBAAA,CAAkB,MAAM,CAAK,IAAA,GAAA,CAAI,UAAU,UAAU,CAAA;AACtE,MAAO,OAAA;AAAA,QACL,QAAA,EAAU,GAAI,CAAA,SAAA,CAAU,UAAU,CAAA;AAAA,QAClC,YAAc,EAAA,IAAA;AAAA,QACd,MAAA,EAAQ,GAAI,CAAA,SAAA,CAAU,QAAQ;AAAA,OAChC;AAAA,KACD,CAAA;AAEH,IAAA,OAAO,IAAI,0BAAA,CAA2B,SAAW,EAAA,MAAA,EAAQ,cAAc,CAAA;AAAA;AACzE,EAEA,MAAM,oBAAqD,GAAA;AACzD,IAAA,MAAM,cAAmC,EAAC;AAC1C,IAAA,MAAM,OAAQ,CAAA,GAAA;AAAA,MACZ,IAAK,CAAA,SAAA,CAAU,GAAI,CAAA,OAAM,QAAY,KAAA;AACnC,QAAI,IAAA;AACF,UAAA,MAAM,UAAU,MAAMA,6BAAA;AAAA,YACpB,QAAA;AAAA,YACA,IAAK,CAAA;AAAA,WACP;AACA,UAAM,MAAA,KAAA,GAA6B,OAAQ,CAAA,GAAA,CAAI,CAAM,CAAA,MAAA;AAAA,YACnD,MAAQ,EAAA,CAAA;AAAA,YACR,UAAU,QAAS,CAAA,QAAA;AAAA,YACnB,cAAc,QAAS,CAAA,YAAA;AAAA,YACvB,QAAQ,QAAS,CAAA;AAAA,WACjB,CAAA,CAAA;AACF,UAAY,WAAA,CAAA,IAAA,CAAK,GAAG,KAAK,CAAA;AAAA,iBAClB,GAAK,EAAA;AACZ,UAAA,IAAA,CAAK,MAAO,CAAA,KAAA;AAAA,YACV,CAA6C,0CAAA,EAAA,QAAA,CAAS,QAAQ,CAAA,EAAA,EAAK,GAAG,CAAA;AAAA,WACxE;AAAA;AACF,OACD;AAAA,KACH;AAEA,IAAO,OAAA,WAAA;AAAA;AAEX;;;;"}