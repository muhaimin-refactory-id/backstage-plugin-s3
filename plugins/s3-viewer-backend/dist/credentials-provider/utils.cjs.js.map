{"version":3,"file":"utils.cjs.js","sources":["../../src/credentials-provider/utils.ts"],"sourcesContent":["import { S3 } from '@aws-sdk/client-s3';\nimport {\n  AllowedBuckets,\n  S3Platform,\n} from '@spreadshirt/backstage-plugin-s3-viewer-common';\n\nexport async function fetchBucketsForPlatform(\n  platform: S3Platform,\n  allowedBuckets: AllowedBuckets[],\n): Promise<string[]> {\n  const s3Client = new S3({\n    apiVersion: '2006-03-01',\n    credentials: platform.credentials,\n    endpoint: platform.endpoint,\n    region: platform.region,\n    forcePathStyle: true,\n  });\n\n  const bucketList = await s3Client.listBuckets({});\n\n  const buckets =\n    bucketList.Buckets?.map(b => b.Name || '')\n      .filter(b => b)\n      .filter(b => {\n        const bucketsAllowed =\n          allowedBuckets.find(a => a.platform === platform.endpointName)\n            ?.buckets || [];\n\n        // If no allowedBuckets defined for the platform, all its buckets are allowed by default\n        if (bucketsAllowed.length === 0) {\n          return true;\n        }\n\n        return bucketsAllowed.some(a => {\n          // Add the start/end of regular expression, so no unexpected matches happen\n          // Example: `test` should't match `test-one`, but `test.*` should.\n          return b.match(`^${a}$`);\n        });\n      }) || [];\n\n  return buckets;\n}\n"],"names":["S3"],"mappings":";;;;AAMsB,eAAA,uBAAA,CACpB,UACA,cACmB,EAAA;AACnB,EAAM,MAAA,QAAA,GAAW,IAAIA,WAAG,CAAA;AAAA,IACtB,UAAY,EAAA,YAAA;AAAA,IACZ,aAAa,QAAS,CAAA,WAAA;AAAA,IACtB,UAAU,QAAS,CAAA,QAAA;AAAA,IACnB,QAAQ,QAAS,CAAA,MAAA;AAAA,IACjB,cAAgB,EAAA;AAAA,GACjB,CAAA;AAED,EAAA,MAAM,UAAa,GAAA,MAAM,QAAS,CAAA,WAAA,CAAY,EAAE,CAAA;AAEhD,EAAA,MAAM,OACJ,GAAA,UAAA,CAAW,OAAS,EAAA,GAAA,CAAI,OAAK,CAAE,CAAA,IAAA,IAAQ,EAAE,CAAA,CACtC,MAAO,CAAA,CAAA,CAAA,KAAK,CAAC,CAAA,CACb,OAAO,CAAK,CAAA,KAAA;AACX,IAAM,MAAA,cAAA,GACJ,cAAe,CAAA,IAAA,CAAK,CAAK,CAAA,KAAA,CAAA,CAAE,aAAa,QAAS,CAAA,YAAY,CACzD,EAAA,OAAA,IAAW,EAAC;AAGlB,IAAI,IAAA,cAAA,CAAe,WAAW,CAAG,EAAA;AAC/B,MAAO,OAAA,IAAA;AAAA;AAGT,IAAO,OAAA,cAAA,CAAe,KAAK,CAAK,CAAA,KAAA;AAG9B,MAAA,OAAO,CAAE,CAAA,KAAA,CAAM,CAAI,CAAA,EAAA,CAAC,CAAG,CAAA,CAAA,CAAA;AAAA,KACxB,CAAA;AAAA,GACF,KAAK,EAAC;AAEX,EAAO,OAAA,OAAA;AACT;;;;"}